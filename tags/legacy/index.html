<!doctype html><html lang=pl><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><title>legacy - Nemesis blog</title><meta property="og:title" content="legacy - Nemesis blog"><meta name=twitter:title content="legacy - Nemesis blog"><meta name=author content="Michał Bryłka"><meta property="og:site_name" content="Nemesis blog"><meta property="og:url" content="https://nemesissoft.github.io/tags/legacy/"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.104.3"><link href=/tags/legacy/index.xml rel=alternate type=application/rss+xml title="Nemesis blog"><link href=/tags/legacy/index.xml rel=feed type=application/rss+xml title="Nemesis blog"><link rel=stylesheet href=/css/style.css media=all><link rel=stylesheet href=/css/syntax.css media=all><link rel=stylesheet href=/css/custom.css media=all><script src=/js/script.js></script>
<script src=/js/custom.js></script>
<script defer src=/js/fontawesome.js></script></head><body><header class=site-header><nav class=site-navi><h1 class=site-title><a href=/>Nemesis blog</a></h1><ul class=site-navi-items><li class=site-navi-item-categories><a href=/categories/ title=Categories>Categories</a></li><li class=site-navi-item-tags><a href=/tags/ title=Tags>Tags</a></li><li class=site-navi-item-about><a href=/about/ title=About>About</a></li></ul></nav></header><hr class=site-header-bottom><div class=main role=main><section class="list term-list"><article class=article><a href=/posts/using-records-in-older-frameworks/ class=article-titles><h2 class=article-title>Using Records in legacy .NET Frameworks</h2></a><ul class=article-meta><li class=article-meta-date><time>June 11, 2020</time></li><li class=article-meta-tags><a href=/tags/csharp/><i class="fas fa-tag"></i>
CSharp
</a>&nbsp;</li><li class=article-meta-tags><a href=/tags/records/><i class="fas fa-tag"></i>
Records
</a>&nbsp;</li><li class=article-meta-tags><a href=/tags/legacy/><i class="fas fa-tag"></i>
legacy
</a>&nbsp;</li></ul><div class=article-content><p>Recenly we&rsquo;ve been seeing an increased activities on various blogs due to upcoming .NET 5 release date and one of it&rsquo;s hottest feature - C# 9.0 records.
A lot was written about this feature, starting with <a href=https://devblogs.microsoft.com/dotnet/welcome-to-c-9-0/>MSDN</a>.</p><p>What was not clear however, was whether one can use records in older frameworks - like .NET 4.8.</p><h2 id=anatomy-of-init-only-properties>Anatomy of init-only properties</h2><p>Let&rsquo;s settle our attention on the following example</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>record</span> <span style=color:#a6e22e>Vertebrate</span>(<span style=color:#66d9ef>string</span> Name)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Vertebrate() : <span style=color:#66d9ef>this</span>(<span style=color:#e6db74>&#34;&#34;</span>) { }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> Habitat { Terrestrial, Aquatic, Amphibian }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>record</span> <span style=color:#a6e22e>Reptile</span>(Habitat Habitat) : Vertebrate { }
</span></span></code></pre></div><p>Upon compilation under net5.0 framework moniker, everything works as expected. Change it to however to net48 and you will not be able to compile it. This compiler feature fortunatelly works like opt-in member resolution (similarly to string interpolation). What compiler needs in this case is an accessible class of the following structure</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>//TODO: use appropriate compiler directives for legacy targets - it&#39;s not needed in net5.0</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if NETSTANDARD2_0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> System.Runtime.CompilerServices
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#a6e22e>    [System.ComponentModel.EditorBrowsable(System.ComponentModel.EditorBrowsableState.Never)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IsExternalInit</span> { }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>endif
</span></span></code></pre></div><h3 id=check-if-property-is-init-only>Check if property is init-only</h3><p>After quick research one can spot that init-only setter has special structure:</p><pre tabindex=0><code>.set instance void modreq([System.Runtime]System.Runtime.CompilerServices.IsExternalInit)  DotnetCommunityDemoNet5.Records/Vertebrate::set_Name(string)
</code></pre><p>To determine that setter is init-only one just needs to query the existence of required modifier initialized with aforementioned IsExternalInit type - this code helper should do the trick:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RecordsHelper</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> IsInitOnly(<span style=color:#66d9ef>this</span> PropertyInfo property) =&gt;
</span></span><span style=display:flex><span>        property.CanWrite &amp;&amp; property.SetMethod <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>var</span> setter
</span></span><span style=display:flex><span>            &amp;&amp; setter.ReturnParameter.GetRequiredCustomModifiers() <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>var</span> reqMods &amp;&amp; reqMods.Length &gt; <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            &amp;&amp; Array.IndexOf(reqMods, <span style=color:#66d9ef>typeof</span>(System.Runtime.CompilerServices.IsExternalInit)) &gt; -<span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=consuming-records-in-older-frameworks>Consuming records in older frameworks</h2><p>Fortunatelly, records are not any special types - they are, per se, not specially recognized by CLI/CLR. They are just spcially designed classes with:</p><ul><li>init only properties (default behaviour for positional records)</li><li>free structural equality, IEquatable&lt;> implementation, equality operators</li><li>positional deconstruction</li><li>printing/formatting</li></ul><p>Due to this phenomenon, consuming records is quite straightforward - you are using them as normal classes. If you&rsquo;d like to use <a href=https://devblogs.microsoft.com/dotnet/welcome-to-c-9-0/#with-expressions><strong>with</strong></a> keyword then you need to use C# 9.0+ for instance by specifying that in *.csproj file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;PropertyGroup&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;LangVersion&gt;</span>9.0<span style=color:#f92672>&lt;/LangVersion&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/PropertyGroup&gt;</span>
</span></span></code></pre></div><h2 id=sources>Sources</h2><ul><li><a href=https://gist.github.com/MichalBrylka/417672620d1305de4a6db68698302544>Records producer/consumer</a></li></ul></div><div class=article-readmore><a href=/posts/using-records-in-older-frameworks/>Read more...</a></div><div class=article-floatclear></div></article></section></div><div class=site-footer><div class=copyright>&copy; Copyright 2019-2022</div><ul class=site-footer-items><li class=site-footer-item-rsslink><a href=/tags/legacy/index.xml type=application/rss+xml target=_blank title=RSS><i class="fas fa-rss"></i></a></li><li class=site-footer-item-about><a href=/about/ title=About>About</a></li></ul><div class=powerdby>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/taikii/whiteplain>Whiteplain</a></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-TFL0Z5DXWF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TFL0Z5DXWF",{anonymize_ip:!1})}</script></body></html>